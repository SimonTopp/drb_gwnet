---
title: "LLLTO_Viz"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(reticulate)
library(sf)
library(plotly)
library(feather)
source('../drb_gwnet/2_Analysis/utils.R')
library(ggridges)

knitr::opts_chunk$set(echo = TRUE)
```

## Baseline Comparisons

```{r}
setwd('../river-dl')
spatial <- readRDS('data_DRB/DRB_spatial/network.rds')
edges <- spatial$edges %>% st_as_sf()

metrics <- c('overall_metrics','month_metrics','reach_metrics')

gwn_stats <- metrics %>% map(~combine_replicates('results/baseline/GWN',.))
names(gwn_stats) <- c('temps','months','segs')

rgcn_stats <- metrics %>% map(~combine_replicates('results/baseline/RGCN',.))
names(rgcn_stats) <- c('temps','months','segs')

## Figure for overall difference between the two models

p1 <- gwn_stats$segs %>% mutate(run = 'GraphWaveNet') %>% bind_rows(rgcn_stats$segs %>% mutate(run = 'RGCN')) %>%
  seg_plotter_sf(., 'rmse_mean') +
  facet_wrap(~run) + labs(color = 'RMSE')

p1

baseline_diff <- seg_error_diff(rgcn_stats$segs, gwn_stats$segs, 'RGCN', 'GraphWaveNet',shape=edges)

p2 <- baseline_diff %>% filter(metric == 'rmse_mean') %>% seg_plotter_sf(., 'metric_diff',ll=-1,ul=2, diff = T, network_color = 'white')+
  labs(title = 'RGCN minus GWN',subtitle='Blue=GWN outperformed RGCN', color = 'RMSE\nDifference') +
  theme(title = element_text(size =8))

p2


p3 <- rgcn_stats$months %>% filter(partition == 'tst') %>% mutate(model= 'RGCN') %>%
  bind_rows(gwn_stats$months %>% filter(partition == 'tst') %>% mutate(model = 'GraphWaveNet')) %>%
  pivot_longer(c(rmse_mean, mean_bias_mean)) %>%
  mutate(name = factor(name, levels = c('rmse_mean', 'mean_bias_mean'), labels = c('RMSE','Bias'))) %>%
  ggplot(aes(x=date, y=value, fill=model, shape = name)) +
  scale_fill_viridis_d(end =.6) +
  #scale_y_continuous(breaks = c(0,1,2)) +
  geom_col(position = 'dodge') +
  facet_wrap(~name,nrow=2, scales='free_y') +
  theme_minimal() +
  labs(x = 'Month', y = 'Â°Celsius')


layout <- rbind(c(1,1,2),
                c(1,1,2),
                c(1,1,2),
                c(3,3,3),
                c(3,3,3))

g <- gridExtra::grid.arrange(p1,p2,p3, layout_matrix = layout)

ggsave('../drb_gwnet/2_analysis/figures/baseline_comps.png', plot = g, width = 5, height = 4.5, units = 'in')

rgcn_stats$temps %>% mutate(model = 'RGCN') %>%
  bind_rows(gwn_stats$temps %>% mutate(model = 'GWN')) %>%
  filter(partition == 'tst') %>%
  select(rmse_mean, rmse_top10_mean,rmse_bot10_mean, model) %>%
  pivot_longer(-model) %>%
  mutate(name = case_when(name == 'rmse_top10_mean'~ 'Warmest 10%',
                                                            name == 'rmse_bot10_mean'~ 'Coldest 10%',
                                                            name== 'rmse_mean'~ 'Overall')) %>%
  rename(`Temperature Bin` = name) %>%
  pivot_wider(names_from = model, values_from = value) %>%
  mutate(`GWN-RGCN` = GWN-RGCN) %>%
  relocate(RGCN, .after = GWN) %>%
  kableExtra::kbl(col.names = c('Temperature\nBin','GWN','RGCN','GWN-RGCN')) %>%
  kableExtra::add_header_above(c('Overall RMSE by Temperature Bin' = 4)) %>%
  kableExtra::row_spec(2, bold = T, color = "white", background = "#D7261E") %>%
  kableExtra::row_spec(3, bold = T, color = 'white', background = 'blue') %>%
  kableExtra::row_spec(1, bold = T, color = 'grey') %>%
  kableExtra::kable_material(full_width = F)


rgcn_stats$temps %>% mutate(model = 'RGCN') %>%
  bind_rows(gwn_stats$temps %>% mutate(model = 'GWN')) %>%
  filter(partition == 'tst') %>%
  select(rmse_mean, rmse_top10_mean,rmse_bot10_mean, model) %>%
  pivot_longer(-model) %>%
  mutate(name = case_when(name == 'rmse_top10_mean'~ 'Warmest 10%',
                                                            name == 'rmse_bot10_mean'~ 'Coldest 10%',
                                                            name== 'rmse_mean'~ 'Overall')) %>%
  rename(`Temperature Bin` = name) %>%
  pivot_wider(names_from = model, values_from = value) %>%
  mutate(`GWN-RGCN` = GWN-RGCN) %>%
  relocate(RGCN, .after = GWN) %>%
  kableExtra::kbl(col.names = c('Temperature\nBin','GWN','RGCN','GWN-RGCN')) %>%
  kableExtra::add_header_above(c('Overall RMSE by Temperature Bin' = 4)) %>%
  kableExtra::row_spec(2, bold = T, color = "white", background = "#D7261E") %>%
  kableExtra::row_spec(3, bold = T, color = 'white', background = 'blue') %>%
  kableExtra::row_spec(1, bold = T, color = 'grey') %>%
  kableExtra::kable_material(full_width = F)


rgcn_stats$temps %>% mutate(model = 'RGCN') %>%
  bind_rows(gwn_stats$temps %>% mutate(model = 'GWN')) %>%
  filter(partition == 'tst') %>%
  select(nse_mean, nse_top10_mean,nse_bot10_mean, model) %>%
  pivot_longer(-model) %>%
  mutate(name = case_when(name == 'nse_top10_mean'~ 'Warmest 10%',
                                                            name == 'nse_bot10_mean'~ 'Coldest 10%',
                                                            name== 'nse_mean'~ 'Overall')) %>%
  rename(`Temperature Bin` = name) %>%
  pivot_wider(names_from = model, values_from = value) %>%
  mutate(`GWN Improvement` = GWN-RGCN) %>%
  relocate(RGCN, .after = GWN) %>%
  kableExtra::kbl(col.names = c('Temperature\nBin','GWN','RGCN','GWN-RGCN')) %>%
  kableExtra::add_header_above(c('Overall nse by Temperature Bin' = 4)) %>%
  kableExtra::row_spec(2, bold = T, color = "white", background = "#D7261E") %>%
  kableExtra::row_spec(3, bold = T, color = 'white', background = 'blue') %>%
  kableExtra::row_spec(1, bold = T, color = 'grey') %>%
  kableExtra::kable_material(full_width = F)


p1 <- rgcn_stats$temps %>%
  reshape_metric(.,'rmse') %>% mutate(model = 'RGCN') %>%
  bind_rows(gwn_stats$temps %>% reshape_metric(.,'rmse') %>% mutate(model='GWN')) %>%
  filter(partition =='tst') %>%
  ggplot(.,aes(x = group, y = mean, color = model)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
  theme_bw() +
  ggtitle('RMSE')

p2 <- rgcn_stats$temps %>%
  reshape_metric(.,'nse') %>% mutate(model = 'RGCN') %>%
  bind_rows(gwn_stats$temps %>% reshape_metric(.,'nse') %>% mutate(model='GWN')) %>%
  filter(partition =='tst') %>%
  ggplot(.,aes(x = group, y = mean, color = model)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
  theme_bw() +
  ggtitle('nse')

gridExtra::grid.arrange(p1,p2, ncol = 1, top = 'Mean and SD across replicates')
```

### LTO Comps

```{r}
metrics <- c('overall_metrics','month_metrics','reach_metrics')

gwn_lto_min <- metrics %>% map(~combine_replicates('results/LTO/GWN/min',.))
names(gwn_lto_min) <- c('temps','months','segs')

gwn_lto_max <- metrics %>% map(~combine_replicates('results/LTO/GWN/max', .))
names(gwn_lto_max) <- c('temps','months','segs')


rgcn_lto_min <- metrics %>% map(~combine_replicates('results/LTO/RGCN/min',.))
names(rgcn_lto_min) <- c('temps','months','segs')

rgcn_lto_max <- metrics %>% map(~combine_replicates('results/LTO/RGCN/max',.))
names(rgcn_lto_max) <- c('temps','months','segs')

rgcn_diff_min <- seg_error_diff(rgcn_stats$segs, rgcn_lto_min$segs, 'Baseline', 'Holdout',shape=edges)
rgcn_diff_max <- seg_error_diff(rgcn_stats$segs, rgcn_lto_max$segs, 'Baseline', 'Holdout',shape=edges)

gwn_diff_min <- seg_error_diff(gwn_stats$segs, gwn_lto_max$segs, 'Baseline', 'Holdout', shape=edges)
gwn_diff_max <- seg_error_diff(gwn_stats$segs, gwn_lto_max$segs, 'Baseline', 'Holdout',shape=edges)

full <- rgcn_diff_max %>% mutate(model = 'RGCN', holdout = 'Max Temps') %>%
  bind_rows(rgcn_diff_min%>% mutate(model = 'RGCN', holdout = 'Min Temps')) %>%
  bind_rows(gwn_diff_max  %>% mutate(model = 'GWN', holdout = 'Max Temps')) %>%
  bind_rows(gwn_diff_min  %>% mutate(model = 'GWN', holdout = 'Min Temps')) %>%
  select(seg_id_nat, partition, metric, Baseline, Holdout, metric_diff, model,holdout)

sig_test <- full %>% ungroup() %>%
  group_by(holdout, model, metric, partition) %>%
  nest() %>%
  mutate(wilcox = map(data, ~wilcox.test(.$Baseline, .$Holdout, paired =T) %>% broom::tidy())) %>%
  select(-data) %>%
  unnest(cols = c(wilcox)) %>%
  mutate(p.value = round(p.value,3))

full %>% 
  filter(metric == 'rmse_mean') %>%
  seg_plotter_sf(., 'metric_diff',ll=-2,ul=2, diff = T, network_color = 'white') +
  facet_grid(holdout~model) 
  
ggsave('2_analysis/figures/lto_spatial.png', width = 4, height = 5, units = 'in')

full <- full %>% mutate_all(~ifelse(is.nan(.), NA, .))

lto_full_segs <- gwn_lto_min$segs %>% mutate(run = 'Train Hot/Test Cold', model='GWN') %>%
  bind_rows(gwn_lto_max$segs %>% mutate(run = 'Train Cold/Test Hot', model='GWN')) %>%
  bind_rows(rgcn_lto_max$segs %>% mutate(run = 'Train Cold/Test Hot', model = 'RGCN')) %>%
  bind_rows(rgcn_lto_min$segs %>% mutate(run = 'Train Hot/Test Cold', model = 'RGCN')) %>%
  bind_rows(gwn_stats$segs %>% mutate(run = 'Baseline') %>% mutate(model = 'GWN')) %>%
  bind_rows(rgcn_stats$segs %>% mutate(run = 'Baseline', model = 'RGCN')) %>%
  filter(partition == 'tst') %>%
  select(rmse_mean,rmse_sd,model,run,seg_id_nat) %>%
  mutate_all(~ifelse(is.nan(.),NA,.)) %>%
  pivot_longer(cols=contains(c('sd','mean')),
               names_to=c('metric','type'),
               names_sep = '_') %>%
  pivot_wider(names_from='type', values_from = 'value')


meds <- lto_full_segs %>% 
  group_by(model, run, metric) %>%
  summarise(median = median(mean, na.rm = T))

p_meds <- plyr::ddply(lto_full_segs, c("model",'metric', 'run'), summarise, med = median(mean, na.rm = T)) %>%
  mutate(med = round(med,2))

ggplot(lto_full_segs %>% filter(metric == 'rmse'), aes(x = run, y = mean))+
  geom_violin(width = .5,aes(fill = run),alpha =.5) +
  geom_boxplot(width = .3) +
  coord_cartesian(ylim=c(.75,3)) +
  scale_fill_manual(values=c('grey80',scales::muted('red'),scales::muted('blue'))) +
  geom_text(data = p_meds %>% filter(metric == 'rmse'), aes(x = run, y = med, label = med), 
              size = 3, vjust = -1.5)+
  theme_bw()+
  labs(title = 'Test Error Distribution for Temperature Holdouts', fill = 'Holdout run', y='RMSE across stream reaches') +
  theme(legend.position = 'bottom',axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  facet_wrap(~model)

ggsave('../drb_gwnet/2_analysis/figures/LTO_Segs_Violin.png', width = 5.5, height =4, units = 'in')

ggplot(lto_full_segs %>% filter(metric=='rmse'), aes(x=mean, y = model, fill = run)) +
  stat_density_ridges(alpha = .3, scale = 1, quantile_lines = T,quantiles = 0.5) +
  scale_fill_viridis_d(end = .6) + 
  scale_color_viridis_d(end = .6) +
  #scale_y_discrete(labels = c('Baseline', 'Train Cold/\nTest Hot', 'Train Hot/\nTest Cold')) +
  xlim(0,5) +
  theme_classic() +
  ggtitle('Comparison of Reach Scale RMSE') +
  facet_wrap(~metric, scales = 'free')

lto_full_temps <- 
  gwn_lto_min$temps %>% mutate(run = 'Train Hot/Test Cold', model='GWN') %>%
  bind_rows(gwn_lto_max$temps %>% mutate(run = 'Train Cold/Test Hot', model='GWN')) %>%
  bind_rows(rgcn_lto_max$temps %>% mutate(run = 'Train Cold/Test Hot', model = 'RGCN')) %>%
  bind_rows(rgcn_lto_min$temps %>% mutate(run = 'Train Hot/Test Cold', model = 'RGCN')) %>%
  bind_rows(gwn_stats$temps %>% mutate(run = 'Baseline') %>% mutate(model = 'GWN')) %>%
  bind_rows(rgcn_stats$temps %>% mutate(run = 'Baseline', model = 'RGCN')) %>%
  filter(partition == 'tst') %>%
  select(contains(c('nse','model','run'))) %>%
  select(-contains(c('logged'))) %>%
  rename(top10_mean = nse_top10_mean, top10_sd = nse_top10_sd, bot10_mean = nse_bot10_mean, bot10_sd= nse_bot10_sd) %>%
  pivot_longer(-c(model,run), names_to=c('group','metric'), names_sep = '_') %>%
  pivot_wider(names_from=metric)
  
ggplot(lto_full_temps, aes(x= group, color = run, y = mean))+
  geom_point(position=position_dodge(.3)) +
  geom_errorbar(aes(ymin = mean-sd, ymax=mean+sd), position = position_dodge(.3)) +
  facet_wrap(~model)

lto_full_temps <- 
  gwn_lto_min$temps %>% mutate(run = 'Train Hot/Test Cold', model='GWN') %>%
  bind_rows(gwn_lto_max$temps %>% mutate(run = 'Train Cold/Test Hot', model='GWN')) %>%
  bind_rows(rgcn_lto_max$temps %>% mutate(run = 'Train Cold/Test Hot', model = 'RGCN')) %>%
  bind_rows(rgcn_lto_min$temps %>% mutate(run = 'Train Hot/Test Cold', model = 'RGCN')) %>%
  bind_rows(gwn_stats$temps %>% mutate(run = 'Baseline') %>% mutate(model = 'GWN')) %>%
  bind_rows(rgcn_stats$temps %>% mutate(run = 'Baseline', model = 'RGCN')) %>%
  filter(partition == 'tst') %>%
  select(contains(c('rmse','model','run'))) %>%
  select(-contains(c('logged'))) %>%
  rename(top10_mean = rmse_top10_mean, top10_sd = rmse_top10_sd, bot10_mean = rmse_bot10_mean, bot10_sd= rmse_bot10_sd) %>%
  pivot_longer(-c(model,run), names_to=c('group','metric'), names_sep = '_') %>%
  pivot_wider(names_from=metric)
  
ggplot(lto_full_temps, aes(x= group, color = run, y = mean))+
  geom_point(position=position_dodge(.3)) +
  geom_errorbar(aes(ymin = mean-sd, ymax=mean+sd), position = position_dodge(.3)) +
  facet_wrap(~model)
```


### LLO Comps

```{r}
llo_groups <- read_csv('data_DRB/DRB_spatial/llo_groups.csv')

rgcn_llo <- metrics %>% map(~combine_replicates('results/LLO/RGCN',., subfolders = T))
names(rgcn_llo) <- c('temps','months','segs')

gwn_llo <-  metrics %>% map(~combine_replicates('results/LLO/GWN',., subfolders = T))
names(gwn_llo) <- c('temps','months','segs')

p1 <- rgcn_llo$segs %>% mutate(model = 'RGCN') %>% filter(is.finite(rmse_mean)) %>%
  bind_rows(gwn_llo$segs %>% mutate(model = 'GWN') %>% filter(is.finite(rmse_mean))) %>%
  seg_plotter_sf(., 'rmse_mean') +
  facet_wrap(~model, nrow =1)

p1

rgcn_diff <- seg_error_diff(rgcn_stats$segs, rgcn_llo$segs %>% select(-run), 'Baseline', 'Holdout', shape = edges) %>% filter(is.finite(metric_diff))

gwn_diff <- seg_error_diff(gwn_stats$segs, gwn_llo$segs %>% select(-run), 'Baseline', 'Holdout', shape = edges) %>% filter(is.finite(metric_diff))

full <- gwn_diff %>% select(seg_id_nat, partition, metric, metric_diff) %>% mutate(model = 'GWN') %>%
  bind_rows(rgcn_diff %>% select(seg_id_nat, partition, metric, metric_diff) %>% mutate(model = 'RGCN'))

p2 <-full %>% 
  mutate(metric_diff = ifelse(metric_diff > 3, 3, ifelse(metric_diff < -1, -1, metric_diff))) %>%
  filter(metric == 'rmse_mean', partition == 'tst') %>%
  seg_plotter_sf(., 'metric_diff') +
  #scale_color_gradient2(na.value = 'white', mid = 'grey80', name = 'RMSE\nDifference', breaks = c(-3,-1.5,0,1.5,3),labels = c('<-3', '-1.5', "0", '1.5', '>3')) +
  scale_color_gradient2(na.value = 'white', mid = 'grey80', name = 'RMSE\nDifference') +
  facet_wrap(~model) 

g <- gridExtra::grid.arrange(p1,p2, nrow =2)

ggsave('figures/llo_spatial.png',plot=g, width = 4,height = 6, units = 'in')  

rgcn_base_llo <- rgcn_stats$segs %>% left_join(llo_groups) %>% mutate(model = 'RGCN')

gwn_base_llo <- gwn_stats$segs %>% left_join(llo_groups) %>% mutate(model = 'GWN')

#### Appalachains and Piedmont are mislabelled, need to correct for plotting.
full_reshape <- rgcn_diff %>% mutate(model = 'RGCN') %>%
  bind_rows(gwn_diff %>% mutate(model = 'GWN')) %>%
  left_join(llo_groups) %>%
  mutate(test_group=factor(test_group, levels = c('Coastal_Plains','Appalachians','Piedmont'),
                           labels = c('Coastal','Piedmont', 'Headwaters')))

full_reshape %>%
  filter(partition == 'tst') %>%
  group_by(model, metric) %>%
  summarise(mean_diff = round(mean(metric_diff, na.rm = T),3),
            sd_dff = round(sd(metric_diff, na.rm = T),3),
            median = round(median(metric_diff, na.rm = T),3))

sig_test <- full_reshape %>%
  filter(!is.na(metric_diff)) %>%
  select(-c(Baseline, Holdout)) %>%
  pivot_wider(names_from = model, values_from = metric_diff) %>%
  group_by(test_group, metric, partition) %>%
  nest() %>%
  mutate(wilcox = map(data, ~wilcox.test(.$GWN, .$RGCN, paired = T) %>% broom::tidy())) %>%
  select(-data) %>%
  unnest(cols = c(wilcox)) %>%
  mutate(p.value = round(p.value,4))

sig_test <- full_reshape %>%
  filter(!is.na(metric_diff), partition == 'tst') %>%
  #select(-c(Baseline, Holdout)) %>%
  #pivot_wider(names_from = model, values_from = metric_diff) %>%
  group_by(test_group, model, metric) %>%
  nest() %>%
  mutate(wilcox = map(data, ~wilcox.test(.$Baseline, .$Holdout) %>% broom::tidy())) %>%
  select(-data) %>%
  unnest(cols = c(wilcox)) %>%
  mutate(p.value = round(p.value,3))

diff <- full_reshape %>% group_by(model, metric, test_group) %>%
  summarize(Baseline = median(Baseline),
            Holdout = median(Holdout),
            Diff = Holdout-Baseline) %>%
  mutate(Diff = round(Diff,2))
  
full_reshape %>% filter(!is.na(metric_diff), partition == 'tst', metric == 'rmse_mean') %>%
  select(-metric_diff) %>%
  pivot_longer(c(Baseline, Holdout)) %>%
  ggplot(., aes(x = value, y = test_group)) +
    geom_density_ridges(aes(fill=name),
    quantile_lines = TRUE, quantiles = .5, scale = 0.9, alpha = 0.7,
    vline_size = 1) +
   geom_text(data = diff %>% filter(metric == 'rmse_mean'), 
             aes(x = 5, y = test_group, label = paste0("Î RMSE: ",Diff)), size = 3, vjust = -2)+
  scale_fill_viridis_d(alpha = .3, end = .6) +
  coord_cartesian(xlim=c(0,7)) +
  facet_wrap(~model, nrow=2) +
  #coord_cartesian(xlim=c(0,8)) +
  labs(x = 'RMSE', y='Holdout Region', fill = 'Model Run') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(title = "Test Error Distribution for\nLocation Holdouts")

ggsave('../drb_gwnet/2_analysis/figures/LTO_ridges.png',width = 3.5,height=5, units = 'in')
  
full_reshape %>% filter(!is.na(metric_diff), partition == 'tst', metric == 'nse_mean') %>%
  select(-metric_diff) %>%
  pivot_longer(c(Baseline, Holdout)) %>%
  mutate(test_group = factor(test_group, levels = c('Coastal_Plains','Piedmont','Appalachians'))) %>%
  ggplot(., aes(x = value, y = test_group)) +
    geom_density_ridges(aes(fill=name),
    quantile_lines = TRUE, quantiles = .5, scale = 0.9, alpha = 0.7,
    vline_size = 1) +
   geom_text(data = diff %>% filter(metric == 'nse_mean'), 
             aes(x = 0, y = test_group, label = paste0("Î NSE: ",Diff)), size = 3, vjust = -2)+
  scale_fill_viridis_d(alpha = .3, end = .6) +
  #coord_cartesian(xlim=c(0,1.5)) +
  facet_wrap(~model, nrow=2) +
  coord_cartesian(xlim=c(-1,1)) +
  labs(x = 'RMSE', y='Holdout Region', fill = 'Model Run') +
  theme_bw()


ggsave('figures/llo_dist.png',width = 5.5, height = 4, units = 'in')

llo_full_temps <- 
  gwn_llo$temps %>% mutate(model='GWN') %>%
  bind_rows(rgcn_llo$temps %>% mutate(model = 'RGCN')) %>%
  bind_rows(gwn_stats$temps %>% mutate(run = 'Baseline') %>% mutate(model = 'GWN')) %>%
  bind_rows(rgcn_stats$temps %>% mutate(run = 'Baseline', model = 'RGCN')) %>%
  filter(partition == 'tst') %>%
  select(contains(c('rmse','model','run'))) %>%
  select(-contains(c('logged'))) %>%
  rename(top10_mean = rmse_top10_mean, top10_sd = rmse_top10_sd, bot10_mean = rmse_bot10_mean, bot10_sd= rmse_bot10_sd) %>%
  pivot_longer(-c(model,run), names_to=c('group','metric'), names_sep = '_') %>%
  pivot_wider(names_from=metric)

ggplot(llo_full_temps, aes(x= group, color = run, y = mean))+
  geom_point(position=position_dodge(.3)) +
  geom_errorbar(aes(ymin = mean-sd, ymax=mean+sd), position = position_dodge(.3)) +
  facet_wrap(~model)
```




### PI3NN check
```{r}
full_temps <- rgcn_llo$temps %>% mutate(model = "RGCN") %>%
  bind_rows(gwn_llo$temps %>% mutate(model = 'GWN')) %>%
  filter(partition == 'test') %>%
  pivot_longer(c(contains('sd'),contains('mean')),
               names_to=c('metric','type'),
               names_sep = '_') %>%
  pivot_wider(names_from='type', values_from = 'value') %>%
  bind_rows(lto_full_temps)

pi_temps <- full_temps %>% 
  select(group, run, model, metric, mean) %>%
  filter(metric %in% c('piw','picp','rmse')) %>%
  pivot_wider(names_from = metric,values_from =mean )

ggplot(pi, aes(x = piw, y = picp, color = picp)) +
  geom_point(aes(shape = model))

full_segs <- gwn_lto_min$segs %>% mutate(run = 'Train Hot/Test Cold', model='GWN') %>%
  bind_rows(gwn_lto_max$segs %>% mutate(run = 'Train Cold/Test Hot', model='GWN')) %>%
  bind_rows(rgcn_lto_max$segs %>% mutate(run = 'Train Cold/Test Hot', model = 'RGCN')) %>%
  bind_rows(rgcn_lto_min$segs %>% mutate(run = 'Train Hot/Test Cold', model = 'RGCN')) %>%
  bind_rows(gwn_stats$segs %>% mutate(run = 'Baseline') %>% mutate(model = 'GWN')) %>%
  bind_rows(rgcn_stats$segs %>% mutate(run = 'Baseline', model = 'RGCN')) %>%
  bind_rows(gwn_llo$segs %>% mutate(model = 'GWN')) %>%
  bind_rows(rgcn_llo$segs %>% mutate(model = 'RGCN')) %>%
  filter(partition == 'test') %>%
  pivot_longer(c(contains('sd'),contains('mean')),
               names_to=c('metric','type'),
               names_sep = '_') %>%
  pivot_wider(names_from='type', values_from = 'value')


pi <- full_segs %>% 
  select(run, model, metric, mean) %>%
  filter(metric %in% c('piw','picp','rmse')) %>%
  pivot_wider(names_from = metric,values_from =mean ) %>%
  na.omit() %>%
  mutate(run=factor(run, 
                    levels = c('Baseline', 'Train Hot/Test Cold', 'Train Cold/Test Hot', 'LLO1','LLO2', 'LLO3'), 
                    labels = c('Baseline', 'Train Hot/Test Cold', 'Train Cold/Test Hot', 'Headwater Holdout',
                                 'Piedmont Holdout', 'Coastal Holdout')))

overall <- pi_temps %>% filter(model == 'RGCN', group == 'Overall') %>%
  mutate(run=factor(run, 
                    levels = c('Baseline', 'Train Hot/Test Cold', 'Train Cold/Test Hot', 'LLO1','LLO2', 'LLO3'), 
                    labels = c('Baseline', 'Train Hot/Test Cold', 'Train Cold/Test Hot', 'Headwater Holdout',
                                 'Piedmont Holdout', 'Coastal Holdout')))

ggplot(pi %>% filter(model =='RGCN'), aes(x= picp)) +
  geom_histogram(alpha=.7) +
  geom_vline(aes(xintercept=0.9, color = 'Target PICP')) +
  geom_vline(data = overall, aes(xintercept = picp, color = 'Overall PICP'), alpha = .9) +
  scale_color_manual(values = c('black', 'red')) +
  facet_wrap(~run, scales = 'free_y') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(x = "Prediction Interval Coverage Probablity", title = 'Prediction Interval Coverage Probablity (PICP)\nacross River Segments', color = '')

ggsave('2_analysis/figures/picp.png', width = 5, height = 4, units = 'in')
  
ggplot(pi, aes(x = rmse, y = picp)) +
  geom_hex() +
  #geom_point() +
  scale_x_log10()+
  facet_wrap(~run)
```


### PI3NN Sensitivity to pre training and early stopping    
```{r}
metrics <- c('overall_metrics','month_metrics','reach_metrics')

pinn_grid <- metrics %>% map(~pinsploder('data/out/ci_grid_search',.))
names(pinn_grid) <- c('overall', 'month', 'segs')

p1 <- ggplot(pinn_grid$segs, aes(x = picp, y = early_stopping, fill = early_stopping)) +
  geom_density_ridges(
    quantile_lines = TRUE, quantiles = .5, scale = 2, alpha = 0.7,
    vline_size = 1) +
  theme(legend.position = 'none')+
  geom_vline(aes(xintercept = .9), color = 'red') +
  facet_grid(partition~pt_epochs) +
  ggtitle('PI Coverage Probability')

p2 <- ggplot(pinn_grid$segs, aes(x = piw, y = early_stopping, fill = early_stopping)) +
  geom_density_ridges(
    quantile_lines = TRUE, quantiles = .5, scale = 2, alpha = 0.7,
    vline_size = 1) +
  theme(legend.position = 'none')+
  facet_grid(partition~pt_epochs) +
  ggtitle('Prediction interval width')

g <- gridExtra::grid.arrange(p1, p2, nrow = 2)

ggsave('2_analysis/figures/ci_grid_segs.png', plot = g,width = 7, height = 5, units='in')

p1 <- ggplot(pinn_grid$overall, aes(x=pt_epochs, y = early_stopping, fill = picp)) +
  geom_raster() +
  geom_text(aes(label=round(picp,2))) +
  scale_fill_gradient2(midpoint = .9) +
  theme(legend.position = 'bottom') +
  facet_grid(group~partition) +
  ggtitle('PI Coverage Probability')

p2 <- ggplot(pinn_grid$overall, aes(x=pt_epochs, y = early_stopping, fill = piw)) +
  geom_raster() +
  geom_text(aes(label=round(piw,2))) +
  scale_fill_viridis_c() +
  theme(legend.position = 'bottom') +
  facet_grid(group~partition) +
  ggtitle('Prediction interval width')

g <- gridExtra::grid.arrange(p1,p2, nrow = 1)

ggsave('2_analysis/figures/ci_grid_temps.png', plot = g,width = 10, height = 9, units='in')


 p1 <- ggplot(pinn_grid$month, aes(x=pt_epochs, y = early_stopping, fill = picp)) +
  geom_raster() +
  geom_text(aes(label=round(picp,2))) +
  scale_fill_gradient2(midpoint = .9) +
  facet_grid(date~partition) +
  ggtitle('PI Coverage Probability')


p2 <- ggplot(pinn_grid$month, aes(x=pt_epochs, y = early_stopping, fill = piw)) +
  geom_raster() +
  geom_text(aes(label=round(piw,2))) +
  scale_fill_viridis_c() +
  facet_grid(date~partition) +
  ggtitle('Prediction interval width')

g <- gridExtra::grid.arrange(p1,p2, nrow = 1)
ggsave('2_analysis/figures/ci_grid_months.png', plot = g,width = 10, height = 15, units='in')
```




## Make some plots that show change in segment RMSE as 

```{r pressure, echo=FALSE}
full_log <- llo_rmse %>% full_join(edges %>% st_set_geometry(NULL)) %>% mutate(comp = 'Leave Location Out') %>%
  bind_rows(baseline %>% full_join(edges %>% st_set_geometry(NULL)) %>% mutate(comp = 'Baseline')) 

p1 <- full_log %>%
  seg_plotter_sf(., 'rmse') + 
  facet_wrap(~comp) + 
  ggtitle('RMSE')

check <- full_log %>% 
  select(comp,seg_id_nat, rmse) %>% 
  filter(!is.na(seg_id_nat)) %>% 
  pivot_wider(names_from=comp, values_from = rmse) %>%
  mutate(metric_diff = Baseline-`Leave Location Out`) %>%
  left_join(full_log %>% select(run, seg_id_nat) %>% filter(run != 'baseline'))

p2 <- check %>% mutate(rmse_diff = case_when(rmse_diff > 5 ~ 5,
                                       rmse_diff < -5 ~ -5,
                                       is.numeric(rmse_diff)~rmse_diff)) %>%
  seg_plotter_sf(., 'rmse_diff') +
  scale_color_gradient2(na.value = 'white', mid = 'grey90') +
  ggtitle('RMSE Difference \n(Baseline - LLO)')

medians <- full_log %>% group_by(comp) %>%
  summarise(med = median(rmse, na.rm = T))

p3 <- ggplot(full_log, aes(x = rmse)) + 
  geom_density(fill = 'grey70') +
  geom_vline(data = medians, aes(xintercept =med), color = 'red') +
  facet_wrap(~comp, nrow = 1, scales = 'free_x') +
  theme_minimal()

p4 <- ggplot(check, aes(x = rmse_diff, fill = run)) + 
  geom_density(alpha = .7) +
  geom_vline(aes(xintercept =median(rmse_diff, na.rm=T)), color = 'red') +
  scale_fill_viridis_d(labels = c('Headwaters', 'Piedmont', 'Coastal'))+
  labs(fill = 'Test Group', x = 'rmse difference') +
  theme_minimal()

layout <- rbind(c(1,1,1,2,2),c(1,1,1,2,2),c(3,3,4,4,4))
gridExtra::grid.arrange(p1,p2, p3,p4, layout_matrix = layout) #nrow = 2, widths = c(.66,.33), heights = c(.66,.33))

```

